var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});import{a as withSelectorExports}from"./use-sync-external-store-CarNKQJB.js";const __storeToDerived=new WeakMap,__derivedToStore=new WeakMap,__depsThatHaveWrittenThisTick={current:[]};let __isFlushing=!1;const __pendingUpdates=new Set,__initialBatchValues=new Map;function __flush_internals(relatedVals){const sorted=Array.from(relatedVals).sort((a,b)=>a instanceof Derived&&a.options.deps.includes(b)?1:b instanceof Derived&&b.options.deps.includes(a)?-1:0);for(const derived of sorted){if(__depsThatHaveWrittenThisTick.current.includes(derived))continue;__depsThatHaveWrittenThisTick.current.push(derived),derived.recompute();const stores=__derivedToStore.get(derived);if(stores)for(const store of stores){const relatedLinkedDerivedVals=__storeToDerived.get(store);relatedLinkedDerivedVals&&__flush_internals(relatedLinkedDerivedVals)}}}__name(__flush_internals,"__flush_internals");function __notifyListeners(store){store.listeners.forEach(listener=>listener({prevVal:store.prevState,currentVal:store.state}))}__name(__notifyListeners,"__notifyListeners");function __notifyDerivedListeners(derived){derived.listeners.forEach(listener=>listener({prevVal:derived.prevState,currentVal:derived.state}))}__name(__notifyDerivedListeners,"__notifyDerivedListeners");function __flush(store){if(__pendingUpdates.add(store),!__isFlushing)try{for(__isFlushing=!0;__pendingUpdates.size>0;){const stores=Array.from(__pendingUpdates);__pendingUpdates.clear();for(const store2 of stores){const prevState=__initialBatchValues.get(store2)??store2.prevState;store2.prevState=prevState,__notifyListeners(store2)}for(const store2 of stores){const derivedVals=__storeToDerived.get(store2);derivedVals&&(__depsThatHaveWrittenThisTick.current.push(store2),__flush_internals(derivedVals))}for(const store2 of stores){const derivedVals=__storeToDerived.get(store2);if(derivedVals)for(const derived of derivedVals)__notifyDerivedListeners(derived)}}}finally{__isFlushing=!1,__depsThatHaveWrittenThisTick.current=[],__initialBatchValues.clear()}}__name(__flush,"__flush");const _Store=class _Store{constructor(initialState,options){this.listeners=new Set,this.subscribe=listener=>{var _a,_b;this.listeners.add(listener);const unsub=(_b=(_a=this.options)==null?void 0:_a.onSubscribe)==null?void 0:_b.call(_a,listener,this);return()=>{this.listeners.delete(listener),unsub==null||unsub()}},this.setState=updater=>{var _a,_b,_c;this.prevState=this.state,this.state=(_a=this.options)!=null&&_a.updateFn?this.options.updateFn(this.prevState)(updater):updater(this.prevState),(_c=(_b=this.options)==null?void 0:_b.onUpdate)==null||_c.call(_b),__flush(this)},this.prevState=initialState,this.state=initialState,this.options=options}};__name(_Store,"Store");let Store=_Store;const _Derived=class _Derived{constructor(options){this.listeners=new Set,this._subscriptions=[],this.lastSeenDepValues=[],this.getDepVals=()=>{const prevDepVals=[],currDepVals=[];for(const dep of this.options.deps)prevDepVals.push(dep.prevState),currDepVals.push(dep.state);return this.lastSeenDepValues=currDepVals,{prevDepVals,currDepVals,prevVal:this.prevState??void 0}},this.recompute=()=>{var _a,_b;this.prevState=this.state;const{prevDepVals,currDepVals,prevVal}=this.getDepVals();this.state=this.options.fn({prevDepVals,currDepVals,prevVal}),(_b=(_a=this.options).onUpdate)==null||_b.call(_a)},this.checkIfRecalculationNeededDeeply=()=>{for(const dep of this.options.deps)dep instanceof _Derived&&dep.checkIfRecalculationNeededDeeply();let shouldRecompute=!1;const lastSeenDepValues=this.lastSeenDepValues,{currDepVals}=this.getDepVals();for(let i=0;i<currDepVals.length;i++)if(currDepVals[i]!==lastSeenDepValues[i]){shouldRecompute=!0;break}shouldRecompute&&this.recompute()},this.mount=()=>(this.registerOnGraph(),this.checkIfRecalculationNeededDeeply(),()=>{this.unregisterFromGraph();for(const cleanup of this._subscriptions)cleanup()}),this.subscribe=listener=>{var _a,_b;this.listeners.add(listener);const unsub=(_b=(_a=this.options).onSubscribe)==null?void 0:_b.call(_a,listener,this);return()=>{this.listeners.delete(listener),unsub==null||unsub()}},this.options=options,this.state=options.fn({prevDepVals:void 0,prevVal:void 0,currDepVals:this.getDepVals().currDepVals})}registerOnGraph(deps=this.options.deps){for(const dep of deps)if(dep instanceof _Derived)dep.registerOnGraph(),this.registerOnGraph(dep.options.deps);else if(dep instanceof Store){let relatedLinkedDerivedVals=__storeToDerived.get(dep);relatedLinkedDerivedVals||(relatedLinkedDerivedVals=new Set,__storeToDerived.set(dep,relatedLinkedDerivedVals)),relatedLinkedDerivedVals.add(this);let relatedStores=__derivedToStore.get(this);relatedStores||(relatedStores=new Set,__derivedToStore.set(this,relatedStores)),relatedStores.add(dep)}}unregisterFromGraph(deps=this.options.deps){for(const dep of deps)if(dep instanceof _Derived)this.unregisterFromGraph(dep.options.deps);else if(dep instanceof Store){const relatedLinkedDerivedVals=__storeToDerived.get(dep);relatedLinkedDerivedVals&&relatedLinkedDerivedVals.delete(this);const relatedStores=__derivedToStore.get(this);relatedStores&&relatedStores.delete(dep)}}};__name(_Derived,"Derived");let Derived=_Derived;function useStore(store,selector=d=>d){return withSelectorExports.useSyncExternalStoreWithSelector(store.subscribe,()=>store.state,()=>store.state,selector,shallow)}__name(useStore,"useStore");function shallow(objA,objB){if(Object.is(objA,objB))return!0;if(typeof objA!="object"||objA===null||typeof objB!="object"||objB===null)return!1;if(objA instanceof Map&&objB instanceof Map){if(objA.size!==objB.size)return!1;for(const[k,v]of objA)if(!objB.has(k)||!Object.is(v,objB.get(k)))return!1;return!0}if(objA instanceof Set&&objB instanceof Set){if(objA.size!==objB.size)return!1;for(const v of objA)if(!objB.has(v))return!1;return!0}const keysA=Object.keys(objA);if(keysA.length!==Object.keys(objB).length)return!1;for(let i=0;i<keysA.length;i++)if(!Object.prototype.hasOwnProperty.call(objB,keysA[i])||!Object.is(objA[keysA[i]],objB[keysA[i]]))return!1;return!0}__name(shallow,"shallow");export{Store as S,useStore as u};
//# sourceMappingURL=@tanstack-CDWPKhZ0.js.map
